<!DOCTYPE html>
<html lang="lv">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Laivu Rezervācija</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,wght@0,300;0,400;0,600;0,700;1,300&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --forest: #1a3a2a;
    --moss: #2d5a3d;
    --sage: #7aad8a;
    --water: #4a8fa8;
    --sand: #f5f0e8;
    --cream: #fdfaf4;
    --dark: #1a1a1a;
    --error: #c0392b;
    --success: #27ae60;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--cream);
    min-height: 100vh;
    color: var(--dark);
    background-image: 
      radial-gradient(ellipse at 20% 0%, rgba(74,143,168,0.08) 0%, transparent 60%),
      radial-gradient(ellipse at 80% 100%, rgba(45,90,61,0.08) 0%, transparent 60%);
  }

  header {
    background: var(--forest);
    color: white;
    padding: 20px 40px;
    display: flex;
    align-items: center;
    gap: 16px;
  }

  header svg { opacity: 0.8; }

  header h1 {
    font-family: 'Fraunces', serif;
    font-size: 1.4rem;
    font-weight: 300;
    letter-spacing: 0.5px;
  }

  .container {
    max-width: 760px;
    margin: 48px auto;
    padding: 0 24px 80px;
  }

  .form-title {
    font-family: 'Fraunces', serif;
    font-size: 2.2rem;
    font-weight: 600;
    color: var(--forest);
    margin-bottom: 8px;
  }

  .form-subtitle {
    color: #666;
    font-size: 0.95rem;
    margin-bottom: 40px;
  }

  .section {
    background: white;
    border-radius: 16px;
    padding: 32px;
    margin-bottom: 24px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
    border: 1px solid rgba(0,0,0,0.06);
  }

  .section-title {
    font-family: 'Fraunces', serif;
    font-size: 1.2rem;
    font-weight: 600;
    color: var(--forest);
    margin-bottom: 24px;
    padding-bottom: 12px;
    border-bottom: 2px solid var(--sand);
  }

  .row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .row.single { grid-template-columns: 1fr; }

  .field { display: flex; flex-direction: column; gap: 6px; }

  label {
    font-size: 0.85rem;
    font-weight: 500;
    color: #444;
    letter-spacing: 0.3px;
  }

  label .req { color: var(--moss); margin-left: 2px; }

  input, select, textarea {
    padding: 12px 16px;
    border: 1.5px solid #e0e0e0;
    border-radius: 10px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    color: var(--dark);
    background: white;
    transition: border-color 0.2s, box-shadow 0.2s;
    outline: none;
    width: 100%;
  }

  input:focus, select:focus, textarea:focus {
    border-color: var(--moss);
    box-shadow: 0 0 0 3px rgba(45,90,61,0.1);
  }

  input.error, select.error { border-color: var(--error); }

  textarea { resize: vertical; min-height: 100px; }

  .date-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

  .boat-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 4px;
  }

  .boat-card {
    border: 1.5px solid #e0e0e0;
    border-radius: 12px;
    padding: 16px;
    transition: border-color 0.2s;
  }

  .boat-card:focus-within { border-color: var(--moss); }

  .boat-card-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: 12px;
  }

  .boat-name {
    font-weight: 500;
    font-size: 0.9rem;
    color: var(--forest);
  }

  .boat-price {
    font-size: 0.8rem;
    color: var(--water);
    font-weight: 500;
  }

  .boat-desc {
    font-size: 0.78rem;
    color: #888;
    margin-bottom: 10px;
  }

  .boat-card input {
    text-align: center;
    font-size: 1.1rem;
    font-weight: 500;
    padding: 10px;
  }

  .summary-bar {
    background: var(--sand);
    border-radius: 12px;
    padding: 16px 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 20px;
  }

  .summary-item { text-align: center; }
  .summary-label { font-size: 0.78rem; color: #666; margin-bottom: 4px; }
  .summary-value { font-family: 'Fraunces', serif; font-size: 1.3rem; font-weight: 600; color: var(--forest); }

  .availability-bar {
    margin-top: 16px;
    padding: 12px 16px;
    border-radius: 10px;
    font-size: 0.88rem;
    font-weight: 500;
    display: none;
    align-items: center;
    gap: 8px;
  }

  .availability-bar.checking {
    display: flex;
    background: #f0f4ff;
    color: #4a6fa8;
  }

  .availability-bar.ok {
    display: flex;
    background: #e8f5e9;
    color: var(--success);
  }

  .availability-bar.error {
    display: flex;
    background: #fdecea;
    color: var(--error);
  }

  .spinner {
    width: 14px; height: 14px;
    border: 2px solid currentColor;
    border-top-color: transparent;
    border-radius: 50%;
    animation: spin 0.6s linear infinite;
    flex-shrink: 0;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .submit-btn {
    width: 100%;
    padding: 16px;
    background: var(--forest);
    color: white;
    border: none;
    border-radius: 12px;
    font-family: 'Fraunces', serif;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    margin-top: 8px;
    letter-spacing: 0.5px;
  }

  .submit-btn:hover { background: var(--moss); }
  .submit-btn:active { transform: scale(0.99); }
  .submit-btn:disabled { background: #aaa; cursor: not-allowed; }

  .success-screen {
    display: none;
    text-align: center;
    padding: 60px 40px;
    background: white;
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.06);
  }

  .success-icon {
    width: 64px; height: 64px;
    background: var(--success);
    border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 24px;
    color: white;
    font-size: 28px;
  }

  .success-screen h2 {
    font-family: 'Fraunces', serif;
    font-size: 1.8rem;
    color: var(--forest);
    margin-bottom: 12px;
  }

  .success-screen p { color: #666; line-height: 1.6; }

  .field-error {
    font-size: 0.78rem;
    color: var(--error);
    margin-top: 2px;
  }

  @media (max-width: 600px) {
    .row, .boat-row, .date-row { grid-template-columns: 1fr; }
    header { padding: 16px 20px; }
    .section { padding: 20px; }
    .container { margin: 24px auto; }
  }
</style>
</head>
<body>

<header>
  <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1.5">
    <path d="M3 17l2-8h14l2 8H3z"/><path d="M7 17v2a1 1 0 001 1h8a1 1 0 001-1v-2"/><path d="M12 9V5"/><path d="M9 5h6"/>
  </svg>
  <h1>Laivu noma</h1>
</header>

<div class="container">
  <h2 class="form-title">Laivu rezervācijas forma</h2>
  <p class="form-subtitle">Aizpildiet formu, lai rezervētu laivas jūsu piedzīvojumam uz upes.</p>

  <form id="bookingForm">

    <!-- Contact -->
    <div class="section">
      <div class="section-title">Jūsu kontaktinformācija</div>
      <div class="row" style="margin-bottom:20px">
        <div class="field">
          <label>Vārds <span class="req">*</span></label>
          <input type="text" id="firstName" placeholder="Jānis" required>
        </div>
        <div class="field">
          <label>Uzvārds <span class="req">*</span></label>
          <input type="text" id="lastName" placeholder="Bērziņš" required>
        </div>
      </div>
      <div class="row">
        <div class="field">
          <label>E-pasts <span class="req">*</span></label>
          <input type="email" id="email" placeholder="janis@example.lv" required>
        </div>
        <div class="field">
          <label>Tālrunis <span class="req">*</span></label>
          <input type="tel" id="phone" placeholder="+371 20000000" required>
        </div>
      </div>
    </div>

    <!-- Booking Details -->
    <div class="section">
      <div class="section-title">Detaļas</div>

      <div class="row" style="margin-bottom:20px">
        <div class="field">
          <label>Upe <span class="req">*</span></label>
          <select id="river" required>
            <option value="">— Izvēlieties upi —</option>
            <option value="Salaca">Salaca</option>
          </select>
        </div>
        <div class="field">
          <label>Maršruts <span class="req">*</span></label>
          <select id="route" required disabled>
            <option value="">— Vispirms izvēlieties upi —</option>
          </select>
        </div>
      </div>

      <div class="row single" style="margin-bottom:20px">
        <div class="field">
          <label>Vēlamais sākuma laiks</label>
          <select id="startTime">
            <option value="09:00">09:00</option>
            <option value="10:00" selected>10:00</option>
            <option value="11:00">11:00</option>
            <option value="12:00">12:00</option>
          </select>
        </div>
      </div>

      <div class="field" style="margin-bottom:20px">
        <label>Datumi <span class="req">*</span></label>
        <div class="date-row">
          <div class="field">
            <input type="date" id="startDate" required>
            <small style="color:#888;font-size:0.78rem;margin-top:4px">Sākuma datums</small>
          </div>
          <div class="field">
            <input type="date" id="endDate" required>
            <small style="color:#888;font-size:0.78rem;margin-top:4px">Beigu datums</small>
          </div>
        </div>
      </div>

      <div class="field">
        <label>Laivas <span class="req">*</span></label>
        <div class="boat-row">
          <div class="boat-card">
            <div class="boat-card-header">
              <div class="boat-name">Kajaks Vista</div>
              <div class="boat-price">€30/dienā</div>
            </div>
            <div class="boat-desc">2-vietīgs</div>
            <input type="number" id="kayaks" min="0" value="0" placeholder="0">
          </div>
          <div class="boat-card">
            <div class="boat-card-header">
              <div class="boat-name">Kanoe Loksija</div>
              <div class="boat-price">€30/dienā</div>
            </div>
            <div class="boat-desc">3-vietīgs</div>
            <input type="number" id="canoes" min="0" value="0" placeholder="0">
          </div>
        </div>
      </div>

      <div class="availability-bar" id="availabilityBar">
        <div class="spinner" id="availSpinner" style="display:none"></div>
        <span id="availText"></span>
      </div>

      <div class="summary-bar">
        <div class="summary-item">
          <div class="summary-label">Kopējais cilvēku skaits</div>
          <div class="summary-value" id="totalSeats">0</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Dienas</div>
          <div class="summary-value" id="totalDays">—</div>
        </div>
        <div class="summary-item">
          <div class="summary-label">Aptuvenā cena</div>
          <div class="summary-value" id="totalPrice">€0</div>
        </div>
      </div>
    </div>

    <!-- Notes -->
    <div class="section">
      <div class="section-title">Papildu informācija</div>
      <div class="field">
        <label>Komentāri vai jautājumi</label>
        <textarea id="notes" placeholder="Jebkāda papildu informācija..."></textarea>
      </div>
    </div>

    <button type="submit" class="submit-btn" id="submitBtn">Rezervēt</button>
  </form>

  <div class="success-screen" id="successScreen">
    <div class="success-icon">✓</div>
    <h2>Paldies par rezervāciju!</h2>
    <p>Mēs saņēmām jūsu pieteikumu un sazināsimies ar jums tuvākajā laikā, lai apstiprinātu rezervāciju.<br><br>
    Pārbaudiet savu e-pastu <strong id="confirmEmail"></strong></p>
  </div>
</div>

<script>
const SUBMIT_URL = 'https://boat-availability.vercel.app/api/submit-booking';

const ROUTES = {
  Salaca: [
    { name: 'Mazsalaca → Līču skola', days: 1, hub: 'Mazsalaca' },
    { name: 'Mazsalaca → Staicele', days: 2, hub: 'Mazsalaca' }
  ]
};

const riverEl = document.getElementById('river');
const routeEl = document.getElementById('route');
const startDateEl = document.getElementById('startDate');
const endDateEl = document.getElementById('endDate');
const kayaksEl = document.getElementById('kayaks');
const canoesEl = document.getElementById('canoes');
const totalSeatsEl = document.getElementById('totalSeats');
const totalDaysEl = document.getElementById('totalDays');
const totalPriceEl = document.getElementById('totalPrice');
const availBar = document.getElementById('availabilityBar');
const availText = document.getElementById('availText');
const availSpinner = document.getElementById('availSpinner');
const submitBtn = document.getElementById('submitBtn');

// Set min date to today
const today = new Date().toISOString().split('T')[0];
startDateEl.min = today;
endDateEl.min = today;

// River → Route
riverEl.addEventListener('change', () => {
  const river = riverEl.value;
  routeEl.innerHTML = '<option value="">— Izvēlieties maršrutu —</option>';
  routeEl.disabled = !river;
  if (river && ROUTES[river]) {
    ROUTES[river].forEach((r, i) => {
      routeEl.innerHTML += `<option value="${i}">${r.name} (${r.days} ${r.days === 1 ? 'diena' : 'dienas'})</option>`;
    });
  }
  resetAvailability();
});

// Route → auto-set end date
routeEl.addEventListener('change', () => {
  updateEndDate();
  checkAvailability();
});

startDateEl.addEventListener('change', () => {
  updateEndDate();
  checkAvailability();
});

function updateEndDate() {
  const river = riverEl.value;
  const routeIdx = routeEl.value;
  if (!river || routeIdx === '' || !startDateEl.value) return;
  const route = ROUTES[river][routeIdx];
  const start = new Date(startDateEl.value);
  start.setDate(start.getDate() + route.days);
  endDateEl.value = start.toISOString().split('T')[0];
  updateSummary();
}

kayaksEl.addEventListener('input', () => { updateSummary(); checkAvailability(); });
canoesEl.addEventListener('input', () => { updateSummary(); checkAvailability(); });

function updateSummary() {
  const kayaks = parseInt(kayaksEl.value) || 0;
  const canoes = parseInt(canoesEl.value) || 0;
  const seats = kayaks * 2 + canoes * 3;
  totalSeatsEl.textContent = seats;

  if (startDateEl.value && endDateEl.value) {
    const start = new Date(startDateEl.value);
    const end = new Date(endDateEl.value);
    const days = Math.round((end - start) / (1000 * 60 * 60 * 24));
    totalDaysEl.textContent = days > 0 ? days : '—';
    const price = (kayaks + canoes) * 30 * (days > 0 ? days : 0);
    totalPriceEl.textContent = `€${price}`;
  }
}

let availTimer = null;
function checkAvailability() {
  clearTimeout(availTimer);
  availTimer = setTimeout(_checkAvailability, 600);
}

async function _checkAvailability() {
  const river = riverEl.value;
  const routeIdx = routeEl.value;
  const kayaks = parseInt(kayaksEl.value) || 0;
  const canoes = parseInt(canoesEl.value) || 0;

  if (!river || routeIdx === '' || !startDateEl.value || !endDateEl.value || (kayaks + canoes) === 0) {
    resetAvailability();
    return;
  }

  const route = ROUTES[river][routeIdx];
  const hub = route.hub;

  availBar.className = 'availability-bar checking';
  availSpinner.style.display = 'block';
  availText.textContent = 'Pārbaudām pieejamību...';

  try {
    const url = `https://boat-availability.vercel.app/api/check-availability?hub=${encodeURIComponent(hub)}&start_date=${startDateEl.value}&end_date=${endDateEl.value}`;
    const res = await fetch(url);
    const data = await res.json();

    availSpinner.style.display = 'none';

    const enoughKayaks = data.available_kayaks >= kayaks;
    const enoughCanoes = data.available_canoes >= canoes;

    if (enoughKayaks && enoughCanoes) {
      availBar.className = 'availability-bar ok';
      availText.textContent = `✓ Pieejams! Kajaki: ${data.available_kayaks}, Kanoe: ${data.available_canoes}`;
      submitBtn.disabled = false;
    } else {
      availBar.className = 'availability-bar error';
      let msg = '✗ Nav pietiekami brīvu laivu. ';
      if (!enoughKayaks) msg += `Kajaki: pieejami ${data.available_kayaks}, pieprasīti ${kayaks}. `;
      if (!enoughCanoes) msg += `Kanoe: pieejami ${data.available_canoes}, pieprasīti ${canoes}.`;
      availText.textContent = msg;
      submitBtn.disabled = true;
    }
  } catch (e) {
    availSpinner.style.display = 'none';
    availBar.className = 'availability-bar error';
    availText.textContent = 'Neizdevās pārbaudīt pieejamību. Lūdzu, mēģiniet vēlreiz.';
  }
}

function resetAvailability() {
  availBar.className = 'availability-bar';
  submitBtn.disabled = false;
}

// Form submit
document.getElementById('bookingForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  submitBtn.disabled = true;
  submitBtn.textContent = 'Sūta...';

  const river = riverEl.value;
  const routeIdx = routeEl.value;
  const route = ROUTES[river][routeIdx];
  const firstName = document.getElementById('firstName').value;
  const lastName = document.getElementById('lastName').value;

  const days = Math.round((new Date(endDateEl.value) - new Date(startDateEl.value)) / 86400000);

  try {
    const res = await fetch('https://boat-availability.vercel.app/api/submit-booking', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        firstName,
        lastName,
        email: document.getElementById('email').value,
        phone: document.getElementById('phone').value,
        river,
        route: route.name,
        startDate: startDateEl.value,
        endDate: endDateEl.value,
        kayaks: parseInt(kayaksEl.value) || 0,
        canoes: parseInt(canoesEl.value) || 0,
        startTime: document.getElementById('startTime').value,
        days,
        notes: document.getElementById('notes').value
      })
    });

    if (res.ok) {
      document.getElementById('bookingForm').style.display = 'none';
      document.getElementById('successScreen').style.display = 'block';
      document.getElementById('confirmEmail').textContent = document.getElementById('email').value;
    } else {
      const err = await res.json();
      alert('Kļūda: ' + (err.error?.message || 'Nezināma kļūda'));
      submitBtn.disabled = false;
      submitBtn.textContent = 'Rezervēt';
    }
  } catch (err) {
    alert('Savienojuma kļūda. Lūdzu, mēģiniet vēlreiz.');
    submitBtn.disabled = false;
    submitBtn.textContent = 'Rezervēt';
  }
});
</script>
</body>
</html>
